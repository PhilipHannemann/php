<?php
require_once("Validation.php");

/**
 * Class for validating content
 */
class Credentials{

	private $validate;
	private $username;
	private $password;
	private $isLoggedIn;

	function __construct(){
	    session_start();
	    $this->validate = new Validation();
	}

	public function isLoggedIn(){
		if($this->isLoggedIn === true){
			return true;
		}

		if (!isset($_COOKIE['username'])){
			return false;
		}

		if (!isset($_SESSION['username'])){
			return false;
		}

		if (!isset($_SESSION['password'])){
			return false;
		}

		if ($_SESSION['ip'] != $_SERVER['REMOTE_ADDR']){
			return false;
		}

		if ($_SESSION['ua'] != $_SERVER['HTTP_USER_AGENT']){
			return false;
		}

		if (!isset($_SESSION['initiated'])) {
			session_regenerate_id();
			$_SESSION['initiated'] = 1;
		}



		$usernameCookie = $_COOKIE['username'];
		$usernameSession = $_SESSION['username'];
		$password = $_SESSION['password'];

		if($usernameCookie == $usernameSession){
			$this->username = $usernameSession;
			$this->password = $password;

			$isValid = $this->validate->validateUser($usernameSession, $password);

			if($isValid === false){
				$this->logOut();
			}

			return $isValid;
		}

	}

	public function logIn($user, $password){ 

		$isValid = $this->validate->validateUser($user, $password);

		if($isValid === true){
			$this->setCookie($user);
			$this->setSession($user, $password);
			$this->isLoggedIn = true;
		}else{
			echo "validation failed";
		}
		
		return $isValid;
	}


	public function logOut(){
		$name = $_SESSION['username'];

		unset($_SESSION['username']);
		unset($_SESSION['password']);
		$_SESSION['username'] = null;
		$_SESSION['password'] = null;

		session_destroy();

		setcookie('username', $name, time() - 60 * 60 * 24, '/');
	}

	public function setCookie($name){
		setcookie('username', $name, time() + 60 * 60 * 24, '/');
	}

	public function setSession($name, $pwd){
		ini_set('session.gc_maxlifetime', 60 * 60 * 24);

		$_SESSION['username'] = $name;
		$_SESSION['password'] = $pwd;

		$_SESSION['ip'] = $_SERVER['REMOTE_ADDR'];
		$_SESSION['ua'] = $_SERVER['HTTP_USER_AGENT'];

	}

	public function getUserName(){
		return $this->username;
	}

}

?>
